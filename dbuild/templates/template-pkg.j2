ARG BASE_VERSION=15
FROM ghcr.io/daemonless/base:${BASE_VERSION}

ARG FREEBSD_ARCH=amd64
ARG PACKAGES="{{ name }}"

# --- Metadata (Injected by Generator) ---
LABEL org.opencontainers.image.title="{{ title }}" 
      org.opencontainers.image.description="{{ description }}" 
      org.opencontainers.image.source="{{ repo_url }}" 
      org.opencontainers.image.url="{{ web_url }}" 
      org.opencontainers.image.licenses="Apache-2.0" 
      org.opencontainers.image.vendor="daemonless" 
      org.opencontainers.image.authors="daemonless" 
      io.daemonless.category="{{ category }}" 
      io.daemonless.port="{{ port }}" 
      io.daemonless.arch="${FREEBSD_ARCH}" 
      io.daemonless.pkg-source="pkg" 
      io.daemonless.packages="${PACKAGES}" 
      {%- if mlock %}
      org.freebsd.jail.allow.mlock="required" 
      {%- endif %}

# Install {{ name }}
RUN pkg update && 
    pkg install -y ${PACKAGES} && 
    mkdir -p /app && 
    pkg query '%v' {{ name }} > /app/version && 
    pkg clean -ay && 
    rm -rf /var/cache/pkg/* /var/db/pkg/repos/*

# Copy root filesystem
COPY root/ /

# Set permissions
RUN chmod +x /etc/services.d/{{ name }}/run /healthz

# --- Expose (Injected by Generator) ---
EXPOSE {{ port }}

# --- Volumes (Injected by Generator) ---
VOLUME /config
